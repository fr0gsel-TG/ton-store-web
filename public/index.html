<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <!-- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>TON Store</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f8f8;
            color: #333;
            line-height: 1.6;
            padding: 12px;
            max-width: 100vw;
            overflow-x: hidden;
        }
        
        h1 {
            font-size: 22px;
            margin: 15px 0;
            color: #0088cc;
        }
        
        #products {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }
        
        .product {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .product h3 {
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        .product p {
            color: #666;
            margin-bottom: 12px;
        }
        
        button {
            background: #0088cc;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 15px;
            width: 100%;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        button:active {
            background: #006699;
        }
        
        /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-width: 480px) {
            body {
                padding: 8px;
            }
            
            .product {
                padding: 12px;
            }
            
            button {
                padding: 12px;
                font-size: 16px;
            }
        }
        
        /* –î–ª—è Telegram WebApp */
        html {
            height: 100vh;
            height: -webkit-fill-available;
        }
    </style>
</head>
<body>
    <h1>üõí TON Store</h1>
    <div id="products">
        <p>–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –≤ –±–æ—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ç–æ–≤–∞—Ä—ã.</p>
    </div>

    <script>
        // –í–µ—Ä—Å–∏—è –¥–ª—è –∫–µ—à–∞ (–º–µ–Ω—è–π—Ç–µ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏)
        const VERSION = 'v3_' + Date.now();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        if (window.Telegram?.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            Telegram.WebApp.enableClosingConfirmation();
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–µ—à–∞
            if (!window.location.search.includes('v=')) {
                window.location.search = `?v=${VERSION}`;
                return;
            }
        }
        
        // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ —ç–∫—Ä–∞–Ω—ã
        function adjustLayout() {
            document.documentElement.style.setProperty(
                '--vh', 
                `${window.innerHeight * 0.01}px`
            );
        }
        
        window.addEventListener('resize', adjustLayout);
        adjustLayout();
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
        const query = new URLSearchParams(window.location.search).get('q');
        if (query) {
            loadProducts(query);
        }
        
        async function loadProducts(query) {
            try {
                const response = await fetch(`/api/search?q=${query}&v=${VERSION}`);
                const products = await response.json();
                
                let html = '';
                if (products.length > 0) {
                    products.forEach(p => {
                        html += `
                        <div class="product">
                            <h3>${p.title}</h3>
                            <p>üí∞ ${p.price} ‚ÇΩ</p>
                            <button onclick="buyProduct('${p.id}')">–ö—É–ø–∏—Ç—å</button>
                        </div>`;
                    });
                } else {
                    html = '<p>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                }
                
                document.getElementById('products').innerHTML = html;
            } catch (error) {
                document.getElementById('products').innerHTML = `
                    <p style="color: red">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>
                `;
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }
        
        function buyProduct(productId) {
            if (window.Telegram?.WebApp) {
                Telegram.WebApp.sendData(JSON.stringify({
                    action: 'buy',
                    product_id: productId,
                    version: VERSION
                }));
                Telegram.WebApp.close();
            } else {
                alert(`–¢–æ–≤–∞—Ä ${productId} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É`);
            }
        }
    </script>
</body>
</html>
